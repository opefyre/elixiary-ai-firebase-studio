<!DOCTYPE html>
<html>
<head>
    <title>Firebase User Debug</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Firebase User Debug</h1>
    <div id="output"></div>
    
    <script>
        const firebaseConfig = {
            "projectId": "studio-1063505923-cbb37",
            "appId": "1:608849643395:web:cadb73d82f7dcd849158b6",
            "apiKey": "AIzaSyBpXf3HbU9GtT_OBkAUAdzAGMnfn6RyU8s",
            "authDomain": "studio-1063505923-cbb37.firebaseapp.com",
            "measurementId": "",
            "messagingSenderId": "608849643395"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        async function debugUser() {
            const output = document.getElementById('output');
            
            // Check current user
            const user = auth.currentUser;
            output.innerHTML += `<p><strong>Current User:</strong> ${user ? user.uid : 'Not signed in'}</p>`;
            
            if (user) {
                output.innerHTML += `<p><strong>User Email:</strong> ${user.email}</p>`;
                output.innerHTML += `<p><strong>User UID:</strong> ${user.uid}</p>`;
                
                // Try to read user document
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    output.innerHTML += `<p><strong>User Document Exists:</strong> ${userDoc.exists}</p>`;
                    
                    if (userDoc.exists) {
                        const data = userDoc.data();
                        output.innerHTML += `<p><strong>Subscription Tier:</strong> ${data.subscriptionTier || 'Not set'}</p>`;
                        output.innerHTML += `<p><strong>Subscription Status:</strong> ${data.subscriptionStatus || 'Not set'}</p>`;
                        output.innerHTML += `<p><strong>Stripe Customer ID:</strong> ${data.stripeCustomerId || 'Not set'}</p>`;
                    }
                } catch (error) {
                    output.innerHTML += `<p><strong>Error reading user document:</strong> ${error.message}</p>`;
                    output.innerHTML += `<p><strong>Error code:</strong> ${error.code}</p>`;
                }
                
                // List all users (if possible)
                try {
                    const usersSnapshot = await db.collection('users').get();
                    output.innerHTML += `<p><strong>Total users in collection:</strong> ${usersSnapshot.size}</p>`;
                    
                    usersSnapshot.forEach(doc => {
                        output.innerHTML += `<p>User ID: ${doc.id}</p>`;
                        const data = doc.data();
                        output.innerHTML += `<p>  - Subscription Tier: ${data.subscriptionTier || 'Not set'}</p>`;
                        output.innerHTML += `<p>  - Stripe Customer ID: ${data.stripeCustomerId || 'Not set'}</p>`;
                    });
                } catch (error) {
                    output.innerHTML += `<p><strong>Error listing users:</strong> ${error.message}</p>`;
                }
            }
        }

        // Sign in with Google
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(() => {
                debugUser();
            }).catch(error => {
                document.getElementById('output').innerHTML += `<p><strong>Sign in error:</strong> ${error.message}</p>`;
            });
        }

        // Debug on page load
        auth.onAuthStateChanged((user) => {
            if (user) {
                debugUser();
            } else {
                document.getElementById('output').innerHTML += '<p>Not signed in. <button onclick="signInWithGoogle()">Sign in with Google</button></p>';
            }
        });
    </script>
</body>
</html>
